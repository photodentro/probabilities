<!doctype html> 
<!-- Copyright (C) 2018 Alkis Georgopoulos <alkisg@gmail.com>. License: GPf3. -->
<html lang="el"> 
<head> 
  <meta charset="UTF-8" />
  <!-- Using this metatag users can't scale the page using pinchIn/out gestures on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>Πιθανότητες</title> 
  <script src="https://code.createjs.com/1.0.0/easeljs.min.js"></script>
  <style type="text/css">
    /* Remove margins and HTML scrollbars */
    body, html  {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: black;
    }
    #mainCanvas {
    padding: 0;
    margin: auto;
    display: block;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    }
  </style>
</head>
<body onload = "init();">
  <canvas id="mainCanvas" width="320" height="180">
    Your browser doesn't support HTML5!
  </canvas>
<script>
  var stage;
  var resourceNames = ['bar_home', 'bar_help', 'bar_about', 'wheelBase', 'wheelPointer'];
  var resourcesLoaded = 0;
  var resources = [];
  var ratio = 16/9;
  var winratio;
  var menubar = [];
  var bg;
  var wheelBase;
  var margin;
  var bbs;
  var leftBox = new createjs.Shape();
  var rightBox = new createjs.Shape();
  var spinningWheel = [];
  var colors;
  var wheelColors;
  var probabilities;
  var wheelSpins;
  var rotSpeed;
  var bc = new createjs.Shape(); //the bar chart shape
  var bcColors = [];
  var bcData = [];

  function init(){
    console.clear();
    stage = new createjs.Stage("mainCanvas");
    stage.enableMouseOver();
    
    // Resource preloading
    for (var i = 0; i < resourceNames.length; i++) {

      resources[i] = new Image();
      resources[i].src = "resource/" + resourceNames[i] + ".svg";
      resources[i].onload = queueFileLoad;

    }
    // The last queueFileLoad calls queueComplete. Execution continues there.

  }

function imgByName(name) {
  return resources[resourceNames.indexOf(name)];
}

function queueFileLoad(event) {
  resourcesLoaded++;
  stage.update();
  if (resourcesLoaded == resourceNames.length)
    queueComplete(event);
}

function queueComplete(event) {
  console.log("Finished loading resources");
  bg = new createjs.Shape();
  bg.graphics.beginFill('white').drawRect(0,0,stage.canvas.width,stage.canvas.height);
  stage.addChild(bg);
  
  var onMenuClick = [onMenuHome, onMenuHelp, onMenuAbout,];
  for (i = 0; i < 3; i++) {
    menubar[i] = new createjs.Bitmap(resources[resourceNames.indexOf("bar_home") + i]);
    menubar[i].addEventListener("click", onMenuClick[i]);
    menubar[i].addEventListener("mouseover", function(event) {
      // Bring the target on top in its container, mostly for the rotation animation
      event.target.parent.setChildIndex(event.target, event.target.parent.numChildren - 1);
      event.target.scaleX = 1.2*event.target.savedscaleX;
      event.target.scaleY = 1.2*event.target.savedscaleY;
      stage.update();
      });
    menubar[i].addEventListener("mouseout", function(event) {
      event.target.scaleX = event.target.savedscaleX;
      event.target.scaleY = event.target.savedscaleY;
      stage.update();
      });
    stage.addChild(menubar[i]);
    wheelSpins = false;
  }


  wheelBase = new createjs.Bitmap(imgByName('wheelBase'));
  stage.addChild(wheelBase);
  wheelPointer = new createjs.Bitmap(imgByName('wheelPointer'));
  stage.addChild(wheelPointer);
  stage.update();
  resize();
  window.addEventListener('resize', resize, false);
  createjs.Ticker.on("tick", tick);
}


function resize() {
  // Resize the canvas element
  winratio = window.innerWidth/window.innerHeight;
  if (winratio >= ratio) {
    stage.canvas.height = window.innerHeight;
    stage.canvas.width = stage.canvas.height * ratio;
  } else {
    stage.canvas.width = window.innerWidth;
    stage.canvas.height = stage.canvas.width / ratio;
  }
  bg.graphics.beginFill('white').drawRect(0,0,stage.canvas.width,stage.canvas.height);
  stage.addChild(bg);


  bbs = stage.canvas.height / 10;  // bar button size
  var bbm = bbs / 5;  // bar button margin
  // TODO: local/global variables, eslint...
  for (i = 0; i < 3; i++) {
    // Leave one space for the level
    menubar[i].scaleX = bbs / menubar[i].image.width;
    menubar[i].scaleY = bbs / menubar[i].image.height;
    menubar[i].regX = menubar[i].image.width / 2;
    menubar[i].regY = menubar[i].image.height / 2;
    menubar[i].x = (i + 1)*bbm + bbs/2 + i*bbs;
    menubar[i].y = stage.canvas.height - bbm - bbs/2;
    // These copies are used to preserve the original scale on mouseover
    menubar[i].savedscaleX = menubar[i].scaleX;
    menubar[i].savedscaleY = menubar[i].scaleY;
   	stage.setChildIndex(menubar[i],stage.numChildren - 1); 
  }
  
  margin = stage.canvas.height / 40;

  wheelBase.scaleY = (stage.canvas.height - 3*margin - bbs)/wheelBase.image.height;
  wheelBase.scaleX = wheelBase.scaleY;
  wheelBase.regX = wheelBase.image.width / 2;
  wheelBase.regY = wheelBase.image.height / 2;
  wheelBase.x = stage.canvas.width / 4;
  wheelBase.y = stage.canvas.height / 2 - bbs / 2;
  wheelBase.on('click',function(){
    wheelSpins = true;
    rotSpeed = 8 + 4*Math.random();
  })

  wheelPointer.scaleY = (stage.canvas.height - 3*margin - bbs)/wheelBase.image.height;
  wheelPointer.scaleX = wheelPointer.scaleY;
  wheelPointer.regX = wheelPointer.image.width / 2;
  wheelPointer.regY = wheelPointer.image.height / 2;
  wheelPointer.x = stage.canvas.width / 4;
  wheelPointer.y = stage.canvas.height / 2 - bbs / 2;

  
  leftBox.graphics.clear();
  leftBox.graphics.setStrokeStyle(5).beginStroke('#fe1133').drawRoundRect(margin,margin,stage.canvas.width / 2 - 2 * margin, stage.canvas.height - bbs - 2*margin,margin).endStroke();
  stage.addChild(leftBox);

  rightBox.graphics.clear();
  rightBox.graphics.beginFill('#fe1133').drawRoundRect(stage.canvas.width / 2 + margin,margin,stage.canvas.width / 2 - 2 * margin, stage.canvas.height - bbs - 2*margin,margin);
  stage.addChild(rightBox);
  stage.addChild(wheelBase);

  colors = ['red','green','blue','yellow','pink','lightgreen','lightblue','magenta'];
  wheelColors = colors.slice();
  probabilities = [12.5,12.5,12.5,12.5,12.5,12.5,12.5,12.5,];
  
  drawSpinningWheel();
  for (var i =0; i < colors.length; i++){
    stage.addChild(spinningWheel[i]);  
  }

  stage.addChild(wheelPointer);//pointer is on top of circle
  drawGraph();
  stage.update();
}


function onMenuHelp(event) {
  alert("Κάντε κλικ στον τροχό για να αλλάξετε τα χρώματά του και κάντε κλικ στην βάση του για να τον περιστρέψετε.");
}

function onMenuHome(event) {
  window.history.back();
}


function onMenuAbout(event) {
  window.open("credits/index_DS_II.html");
}


function tick(event){
  if (wheelSpins){
    if (rotSpeed < 0.01){
      wheelSpins = false;
      //wheel stops this means we have to draw the chart
      
      //if it is the first spin the bcColors must be 
      //computed
      if (bcColors.length == 0){//first spin
            for (var i=0; i<wheelColors.length; i++){
              if (bcColors.indexOf(wheelColors[i])<0){//if not already in bcColors
                bcColors.push(wheelColors[i]);
              }
            }
            for (var i=0; i<bcColors.length; i++){
              bcData[i] = 0;
            }
          }

      //find the color of the wheel and add it to data
      for (var i=0; i<colors.length; i++){
        //from https://www.createjs.com/tutorials/HitTest/globalToLocal.html
        var pt = spinningWheel[i].globalToLocal(stage.canvas.width / 4, stage.canvas.height / 4);
        if (spinningWheel[i].hitTest(pt.x,pt.y)){
          var spinColor = spinningWheel[i].arcColor;
          bcData[bcColors.indexOf(spinColor)] += 1;
          if (bcData[bcColors.indexOf(spinColor)] > 10){
            bcData[bcColors.indexOf(spinColor)] = 10;
          }
        }
      }

      //draw the new graph
      drawGraph();
    }
    else{    
      rotSpeed -= 0.1;
      for (var i=0; i<colors.length; i++){
        spinningWheel[i].rotation += rotSpeed;
      }
      stage.update();
    }
  }//if it does not spin no problem
}

function drawSpinningWheel(){
  var startAngle = 0;
  var endAngle = 0;
  r = stage.canvas.height * 0.35;
  for (var i = 0; i<colors.length; i++){
    if (spinningWheel[i]){
      spinningWheel[i].graphics.clear();
    }
    else{
      spinningWheel[i] = new createjs.Shape();
      spinningWheel[i].ind = i;
    }
    spinningWheel[i].x = stage.canvas.width / 4;
    spinningWheel[i].y = stage.canvas.height * 0.4;    
    endAngle = startAngle + 2*Math.PI*probabilities[i]/100;
    spinningWheel[i].startAngle = startAngle;
    spinningWheel[i].endAngle = endAngle;
    spinningWheel[i].arcColor = wheelColors[i];
    spinningWheel[i].graphics.setStrokeStyle(2).beginStroke(spinningWheel[i].arcColor).beginFill(spinningWheel[i].arcColor).arc(0,0,r,spinningWheel[i].startAngle,spinningWheel[i].endAngle);
    spinningWheel[i].graphics.lt(0,0).endStroke();
    spinningWheel[i].on('click',function(event){
      bcColors = [];
      bc.graphics.clear();
      wheelColors[event.target.ind] = colors[(colors.indexOf(event.target.arcColor) + 1) % colors.length];
      event.target.arcColor = wheelColors[event.target.ind];
      event.target.graphics.setStrokeStyle(2).beginStroke(event.target.arcColor).beginFill(event.target.arcColor).arc(0,0,r,event.target.startAngle,event.target.endAngle);
      event.target.graphics.lt(0,0).endStroke();
      stage.addChild(event.target);//bring shape to front
      stage.addChild(wheelPointer);
      stage.update();
      console.log(colors);
    });
    startAngle = endAngle; //for next arc

    stage.addChild(spinningWheel[i]);
  }
  stage.update();
}

function drawGraph(){
	  bc.graphics.clear();
      bc.graphics.setStrokeStyle(2).beginStroke('black');
      for (var i=0; i<bcColors.length; i++){
        var l = bcColors.length;
        var barWidth = (stage.canvas.width / 2 - 2 * margin)/l;
        var barHeight = (stage.canvas.height - bbs - 2*margin) / 10;
        for (var j=0; j<bcData[i]; j++){
          bc.graphics.beginFill(bcColors[i]).drawRect(stage.canvas.width / 2 + margin + i*barWidth, margin + (9-j)*barHeight, barWidth, barHeight);
        }
      }
      bc.graphics.endStroke();
      stage.addChild(bc);
      stage.update();

}


</script>
</body>
</html>